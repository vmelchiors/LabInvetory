{% extends 'base.html' %}

{% block title %}Lista de Empréstimos{% endblock %}

{% block content %}
<h1>Empréstimos</h1>

<p><a href="{% url 'loan_create' %}">Novo Empréstimo</a></p>

<h2>Filtros</h2>
<form method="get">
    <label for="q">Pesquisar:</label><br>
    <input type="text" id="q" name="q" value="{{ query }}" placeholder="Usuário ou material..."><br><br>

    <label for="status">Status:</label><br>
    <select id="status" name="status">
        <option value="" {% if not status %}selected{% endif %}>Todos</option>
        <option value="active" {% if status == 'active' %}selected{% endif %}>Ativos</option>
        <option value="returned" {% if status == 'returned' %}selected{% endif %}>Devolvidos</option>
        <option value="late" {% if status == 'late' %}selected{% endif %}>Atrasados</option>
    </select><br><br>

    <label for="start_date">Data Inicial:</label><br>
    <input type="date" id="start_date" name="start_date" value="{{ start_date }}"><br><br>

    <label for="end_date">Data Final:</label><br>
    <input type="date" id="end_date" name="end_date" value="{{ end_date }}"><br><br>

    <button type="submit">Filtrar</button>
    <a href="{% url 'loan_list' %}">Limpar</a>
</form>

<hr>

<h2>Lista de Empréstimos</h2>

{% if loans %}
    <table border="1" cellpadding="5" cellspacing="0">
        <thead>
            <tr>
                <th>ID</th>
                <th>Usuário</th>
                <th>Data do Empréstimo</th>
                <th>Prazo de Devolução</th>
                <th>Status</th>
                <th>Qtd. Itens</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for loan in loans %}
            <tr>
                <td>{{ loan.id }}</td>
                <td>{{ loan.user.username }}</td>
                <td>{{ loan.loan_date|date:"d/m/Y" }}</td>
                <td>{{ loan.due_date|date:"d/m/Y" }}</td>
                <td>
                    {% if loan.status == 'active' %}
                        Ativo
                    {% elif loan.status == 'returned' %}
                        Devolvido
                    {% elif loan.status == 'late' %}
                        Atrasado
                    {% endif %}
                </td>
                <td>{{ loan.loanitem_set.count }}</td>
                <td>
                    <a href="{% url 'loan_detail' loan.pk %}">Ver</a>
                    {% if loan.status != 'returned' %}
                        | <a href="{% url 'loan_return' loan.pk %}">Devolver</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>Nenhum empréstimo encontrado com os filtros aplicados.</p>
{% endif %}
{% endblock %}
