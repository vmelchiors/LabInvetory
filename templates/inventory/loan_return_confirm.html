{% extends 'base.html' %}

{% block title %}Confirmar Devolução{% endblock %}

{% block content %}
<h2>Confirmar Devolução de Empréstimo</h2>

<p><strong>Você está prestes a confirmar a devolução de todos os itens do empréstimo #{{ loan.id }}.</strong></p>
<p>Esta ação marcará todos os itens como devolvidos e atualizará o estoque disponível.</p>

<hr>

<h3>Detalhes do Empréstimo</h3>
<dl>
    <dt>Usuário:</dt>
    <dd>{{ loan.user.username }}</dd>

    <dt>Data do Empréstimo:</dt>
    <dd>{{ loan.loan_date|date:"d/m/Y H:i" }}</dd>

    <dt>Prazo de Devolução:</dt>
    <dd>{{ loan.due_date|date:"d/m/Y" }}</dd>

    <dt>Status:</dt>
    <dd>
        {% if loan.status == 'active' %}
            Ativo
        {% elif loan.status == 'late' %}
            Atrasado
        {% endif %}
    </dd>

    <dt>Total de Itens:</dt>
    <dd>{{ loan.loanitem_set.count }}</dd>

    {% if loan.notes %}
        <dt>Observações:</dt>
        <dd>{{ loan.notes }}</dd>
    {% endif %}
</dl>

<hr>

<h3>Itens a Serem Devolvidos</h3>
<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Material</th>
            <th>Quantidade Emprestada</th>
            <th>Já Devolvida</th>
            <th>A Devolver</th>
        </tr>
    </thead>
    <tbody>
        {% for item in loan.loanitem_set.all %}
            {% with pending=item.quantity|sub:item.returned_quantity %}
            {% if pending > 0 %}
            <tr>
                <td>{{ item.material.name }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.returned_quantity }}</td>
                <td>{{ pending }}</td>
            </tr>
            {% endif %}
            {% endwith %}
        {% endfor %}
    </tbody>
</table>

<hr>

<form method="post">
    {% csrf_token %}
    <p>
        <a href="{% url 'loan_detail' loan.pk %}">Cancelar</a>
        <button type="submit">Confirmar Devolução</button>
    </p>
</form>
{% endblock %}
